/**
 * –ü–ª–∞–≥–∏–Ω —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ö–ª—É–±–Ω–∏–∫–∏ –≤ Lampa
 * –í–µ—Ä—Å–∏—è: 1.0.1
 * –ê–≤—Ç–æ—Ä: @Cheeze_l
 * 
 * –û–ø–∏—Å–∞–Ω–∏–µ:
 * –ü–ª–∞–≥–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø–æ–∏—Å–∫–∞ "–ö–ª—É–±–Ω–∏—á–∫–∞".
 * –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–µ —Ç—Ä–µ–±—É–µ—Ç –≤–≤–æ–¥ PIN-–∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞.
 * 
 * –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
 * - –ó–∞—â–∏—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ —Å –ø–æ–º–æ—â—å—é PIN-–∫–æ–¥–∞
 * - –ö–∞—Ä—Ç–æ—á–∫–∞-–∑–∞–≥–ª—É—à–∫–∞ –≤–º–µ—Å—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * - –°–±—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
 * 
 * –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
 * - –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å ES5 (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å—Ç–∞—Ä—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
 * - –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 * 
 * –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
 * 
 * –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Lampa:
 * –í –õ–∞–º–ø–∞ –æ—Ç–∫—Ä—ã—Ç—å "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–†–∞—Å—à–∏—Ä–µ–Ω–∏—è" ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω"
 * –ò –ø—Ä–æ–ø–∏—Å–∞—Ç—å: https://mylampa1.github.io/sisearch_pass.js
 * 
 * –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Lampac:
 * –î–æ–±–∞–≤–∏—Ç—å –≤ lampainit.js —Å—Ç—Ä–æ–∫—É:
 * Lampa.Utils.putScriptAsync(["https://mylampa1.github.io/sisearch_pass.js"], function() {});
 * 
 * –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ—Ä–∞:
 * –ï—Å–ª–∏ –µ—Å—Ç—å –∂–µ–ª–∞—é—â–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∞–≤—Ç–æ—Ä–∞, –ø–∏—à–∏—Ç–µ @Cheeze_l
 */
 
(function() {
  'use strict';

  if (window.sisiParentalControlLoaded) return;
  window.sisiParentalControlLoaded = true;
  window.sisiParentalAuthorized = false;

  var ICON = '<svg viewBox="-100 -121.5 400 486" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M187.714 130.727C206.862 90.1515 158.991 64.2019 100.983 64.2019C42.9759 64.2019 -4.33044 91.5669 10.875 130.727C26.0805 169.888 63.2501 235.469 100.983 234.997C138.716 234.526 168.566 171.303 187.714 130.727Z" stroke="white" stroke-width="15"/><path d="M102.11 62.3146C109.995 39.6677 127.46 28.816 169.692 24.0979C172.514 56.1811 135.338 64.2018 102.11 62.3146Z" stroke="white" stroke-width="15"/><path d="M90.8467 62.7863C90.2285 34.5178 66.0667 25.0419 31.7127 33.063C28.8904 65.1461 68.8826 62.7863 90.8467 62.7863Z" stroke="white" stroke-width="15"/><path d="M100.421 58.5402C115.627 39.6677 127.447 13.7181 85.2149 9C82.3926 41.0832 83.5258 35.4214 100.421 58.5402Z" stroke="white" stroke-width="15"/><rect x="39.0341" y="98.644" width="19.1481" height="30.1959" rx="9.57407" fill="white"/><rect x="90.8467" y="92.0388" width="19.1481" height="30.1959" rx="9.57407" fill="white"/><rect x="140.407" y="98.644" width="19.1481" height="30.1959" rx="9.57407" fill="white"/><rect x="116.753" y="139.22" width="19.1481" height="30.1959" rx="9.57407" fill="white"/><rect x="64.9404" y="139.22" width="19.1481" height="30.1959" rx="9.57407" fill="white"/><rect x="93.0994" y="176.021" width="19.1481" height="30.1959" rx="9.57407" fill="white"/></svg>';

  function isSisiSource(title) {
    return title === '–ö–ª—É–±–Ω–∏—á–∫–∞' || title === 'Strawberry' || title === '–ü–æ–ª—É–Ω–∏—á–∫–∞' || title === 'ËçâËéì';
  }

  function createAuthCard() {
    return {
      title: Lampa.Lang.translate('sisi_parental_control'),
      results: [{
        id: 'sisi_auth_card',
        title: Lampa.Lang.translate('sisi_parental_auth_required'),
        original_title: Lampa.Lang.translate('sisi_parental_click_pin'),
        overview: Lampa.Lang.translate('sisi_parental_pin_description'),
        custom_type: 'sisi_auth_required',
        img: 'data:image/svg+xml;base64,' + btoa(ICON),
        background_image: 'data:image/svg+xml;base64,' + btoa(ICON)
      }]
    };
  }

  function wrapSisiSource(source) {
    var originalSearch = source.search;
    var lastParams = null;
    
    source.search = function(params, oncomplite) {
      lastParams = { params: params, oncomplite: oncomplite };
      
      if (!Lampa.Storage.field('parental_control') || window.sisiParentalAuthorized) {
        originalSearch.call(source, params, oncomplite);
        return;
      }
      
      oncomplite([createAuthCard()]);
    };
    
    var originalOnSelect = source.onSelect;
    source.onSelect = function(params, close) {
      if (params.element && params.element.custom_type === 'sisi_auth_required') {
        if (close) close();
        setTimeout(function() {
          if (Lampa.ParentalControl && Lampa.ParentalControl.query) {
            Lampa.ParentalControl.query(function() {
              window.sisiParentalAuthorized = true;
              Lampa.Noty.show(Lampa.Lang.translate('sisi_parental_pin_accepted'));
              if (lastParams) {
                setTimeout(function() {
                  originalSearch.call(source, lastParams.params, lastParams.oncomplite);
                }, 300);
              }
            }, function() {
              Lampa.Noty.show(Lampa.Lang.translate('sisi_parental_pin_wrong'));
              if (lastParams) lastParams.oncomplite([createAuthCard()]);
            });
          }
        }, 100);
      } else if (originalOnSelect) {
        originalOnSelect.call(source, params, close);
      }
    };
  }

  function interceptSearch() {
    var attempts = 0;
    var wait = setInterval(function() {
      if (Lampa.Search) {
        clearInterval(wait);
        
        if (Lampa.Search.addSource) {
          var originalAddSource = Lampa.Search.addSource;
          Lampa.Search.addSource = function(source) {
            if (source && isSisiSource(source.title)) {
              wrapSisiSource(source);
            }
            return originalAddSource.call(Lampa.Search, source);
          };
        } else {
          var _addSource = null;
          Object.defineProperty(Lampa.Search, 'addSource', {
            get: function() {
              return _addSource;
            },
            set: function(fn) {
              _addSource = function(source) {
                if (source && isSisiSource(source.title)) {
                  wrapSisiSource(source);
                }
                return fn.call(Lampa.Search, source);
              };
            },
            configurable: true
          });
        }
      } else if (++attempts >= 100) {
        clearInterval(wait);
      }
    }, 50);
  }

  function resetAuth() {
    if (Lampa.Listener) {
      Lampa.Listener.follow('app', function(e) {
        if (e.type === 'exit' || e.type === 'destroy') {
          window.sisiParentalAuthorized = false;
        }
      });
    }
    
    if (Lampa.Storage) {
      var originalSet = Lampa.Storage.set;
      Lampa.Storage.set = function(name, value) {
        if (name === 'parental_control') {
          window.sisiParentalAuthorized = false;
        }
        return originalSet.apply(this, arguments);
      };
    }
  }

  function addTranslations() {
    if (!Lampa.Lang) return;
    Lampa.Lang.add({
      sisi_parental_control: {ru: 'üîí –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å', uk: 'üîí –ë–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å', en: 'üîí Parental Control', be: 'üîí –ë–∞—Ü—å–∫–æ—û—Å–∫—ñ –∫–∞–Ω—Ç—Ä–æ–ª—å', zh: 'üîí ÂÆ∂ÈïøÊéßÂà∂'},
      sisi_parental_auth_required: {ru: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', uk: '–ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è', en: 'Authorization required', be: '–ü–∞—Ç—Ä–∞–±—É–µ—Ü—Ü–∞ –∞—û—Ç–∞—Ä—ã–∑–∞—Ü—ã—è', zh: 'ÈúÄË¶ÅÊéàÊùÉ'},
      sisi_parental_click_pin: {ru: '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤–≤–æ–¥–∞ PIN-–∫–æ–¥–∞', uk: '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è PIN-–∫–æ–¥—É', en: 'Click to enter PIN code', be: '–ù–∞—Ü—ñ—Å–Ω—ñ—Ü–µ –¥–ª—è —û–≤–æ–¥—É PIN-–∫–æ–¥–∞', zh: 'ÁÇπÂáªËæìÂÖ•PINÁ†Å'},
      sisi_parental_pin_description: {ru: '–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ PIN-–∫–æ–¥', uk: '–î–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–≤–µ—Å—Ç–∏ PIN-–∫–æ–¥', en: 'Enter PIN code to access content', be: '–î–ª—è –¥–æ—Å—Ç—É–ø—É –¥–∞ –∫–∞–Ω—Ç—ç–Ω—Ç—É –Ω–µ–∞–±—Ö–æ–¥–Ω–∞ —û–≤–µ—Å—Ü—ñ PIN-–∫–æ–¥', zh: 'ËæìÂÖ•PINÁ†ÅËÆøÈóÆÂÜÖÂÆπ'},
      sisi_parental_pin_accepted: {ru: 'PIN-–∫–æ–¥ –ø—Ä–∏–Ω—è—Ç. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∏—Å–∫', uk: 'PIN-–∫–æ–¥ –ø—Ä–∏–π–Ω—è—Ç–æ. –ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –ø–æ—à—É–∫', en: 'PIN accepted. Repeat search', be: 'PIN-–∫–æ–¥ –ø—Ä—ã–Ω—è—Ç—ã. –ü–∞—û—Ç–∞—Ä—ã—Ü–µ –ø–æ—à—É–∫', zh: 'PINÂ∑≤Êé•Âèó„ÄÇÈáçÂ§çÊêúÁ¥¢'},
      sisi_parental_pin_wrong: {ru: '–ù–µ–≤–µ—Ä–Ω—ã–π PIN-–∫–æ–¥', uk: '–ù–µ–≤—ñ—Ä–Ω–∏–π PIN-–∫–æ–¥', en: 'Wrong PIN', be: '–ù—è–ø—Ä–∞–≤—ñ–ª—å–Ω—ã PIN-–∫–æ–¥', zh: 'PINÈîôËØØ'}
    });
  }

  function init() {
    if (!window.Lampa || !Lampa.Storage) {
      setTimeout(init, 100);
      return;
    }
    
    addTranslations();
    resetAuth();
    interceptSearch();
  }

  if (window.Lampa) {
    interceptSearch();
    init();
  } else {
    var waitLampa = setInterval(function() {
      if (window.Lampa) {
        clearInterval(waitLampa);
        interceptSearch();
        init();
      }
    }, 10);
  }

})();
